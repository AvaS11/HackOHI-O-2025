<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>BitByBit - O'ahu Power Network Risk Map</title>

    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.19/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.3.2/dist/esri-leaflet-vector.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>


    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }
      .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>

      const accessToken = "AAPTxy8BH1VEsoebNVZXo8HurNa0nJTojqL3TJXQoAhEb0gewpcjPf3ESg0LAh2gEyF_82fldg-BY0-GEyzhca2DsmmM7iiGbwypEi5sqhB3FMDuyPODF1IeiD1ax2QpWweoqSLGQvcL0jlnDlhm0Sd4-0YHkZQUYXY-3uaH0Kzko0kjck_Q9NCyAwEg_VNhtAqswpCyU0bpgii0UtNVpxmcwsCPLIfvCAirlVwPJnDu8K8ISuhUXV1P-yuoOsEM1MRTAT1_IoZERlYC";
      const basemapEnum = "arcgis/imagery"; // arcgis/navigation, arcgis/imagery, open/osm-style, etc.

      // Create map
      const map = L.map("map").setView([21.48, -157.95], 11);

      // Set darkgray theme
      L.esri.basemapLayer("DarkGray").addTo(map);
      L.esri.basemapLayer("DarkGrayLabels").addTo(map);


// Loading Data: -------------------------------------------------------------------------------------//
      // Load oneline_lines.geojson file (Line locations)
        fetch("oneline_lines.geojson")
          .then((res) => res.json())
          .then((geojson) => {
            const layer = L.geoJSON(geojson, {
              style: function (feature) {
                return {
                  // Line color + weight
                  color: "gray",
                  weight: 2,
                };
              },
              // Popups for each line
              onEachFeature: (feature, layer) => {
              const props = feature.properties;
              layer.bindPopup(`
                <b>${props.LineName || "Unnamed Line"}</b><br>
                Name: ${props.Name || "N/A"}<br>
                Circuit: ${props.Circuit || "N/A"}<br>
                nomkv: ${props.nomkv || "N/A"}
              `);
            },
          }).addTo(map);
        })
        .catch((err) => console.error("Error loading GeoJSON:", err));

      // Load lines.CSV file (Electrical attribute data & line names)
      // Merge data with lines.CSV based on line names shared between files
      let csvData = {};
      Papa.parse("lines.csv", {
      download: true,
        header: true,
        complete: function (results) {
          results.data.forEach((row) => {
            const lat = parseFloat(row.latitude);
            const lon = parseFloat(row.longitude);
            if (!isNaN(lat) && !isNaN(lon)) {
              L.circleMarker([lat, lon], {
                radius: 5,
                fillColor: "#00ffff",
                color: "#ffffff",
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.9,
              })
                .bindPopup(`<b>${row.bus_name || "Bus"}</b><br>Lat: ${lat}<br>Lon: ${lon}`)
                .addTo(map);
            }
          });
        },
      });
//----------------------------------------------------------------------------------------------------//

      // Add legend
      const legend = L.control({ position: "bottomleft" });
      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `
          <b>Title</b><br>
          <span style="color:#00ffff;">■</span> &lt; 0.01<br>
          <span style="color:#00ff00;">■</span> &lt; 0.05<br>
          <span style="color:#ffff00;">■</span> &lt; 0.1<br>
          <span style="color:#ff8800;">■</span> &lt; 0.2<br>
          <span style="color:#ff0000;">■</span> ≥ 0.2<br>
        `;
        return div;
      };
      legend.addTo(map);
        
    </script>

  </body>

</html>
